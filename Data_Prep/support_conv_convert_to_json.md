# Support Conversation Data Pipeline

## Summary
This SQL script creates a comprehensive data pipeline for processing customer support conversations in Snowflake. It establishes a schema for data preparation, creates tables for storing conversation data, implements procedures for generating realistic transcripts using AI, and exports the data to JSON files. The script includes both initial data setup and an ongoing pipeline for generating new conversations, making it suitable for demonstrations of data processing and analytics capabilities.

## Detailed Steps

### 1. Schema Creation
```sql
CREATE SCHEMA IF NOT EXISTS Cursor_Demo.DATA_PREP;
```
Creates a dedicated schema for data preparation within the Cursor_Demo database if it doesn't already exist. This schema will contain all objects related to the support conversation data pipeline.

### 2. Initial Data Table Creation
```sql
CREATE OR REPLACE TABLE Cursor_Demo.DATA_PREP.support_conv_initial AS
SELECT 
    CONVERSATION_ID,
    START_TIME,
    END_TIME,
    sa.AGENT_NAME AS AGENT_NAME,
    c.CUSTOMER_NAME AS CUSTOMER_NAME,
    TRANSCRIPT
FROM 
    Cursor_Demo.V1.SUPPORT_CONVERSATIONS sc
    LEFT JOIN Cursor_Demo.V1.SUPPORT_AGENTS sa ON sa.AGENT_ID = sc.AGENT_ID
    LEFT JOIN Cursor_Demo.V1.CUSTOMERS c ON c.CUSTOMER_ID = sc.CUSTOMER_ID  
;
```
Creates a simplified table that extracts essential conversation data from the original SUPPORT_CONVERSATIONS table. This table includes:
- Conversation ID
- Start and end times
- Agent and customer names (joined from their respective tables)
- The full conversation transcript

### 3. Stage Creation for Initial Data
```sql
CREATE OR REPLACE STAGE Cursor_Demo.DATA_PREP.call_data_initial;
```
Creates a stage in the DATA_PREP schema for storing the initial JSON files containing conversation data.

### 4. Initial JSON Export
```sql
COPY INTO @CURSOR_DEMO.data_prep.call_data_initial/support_conv_initial.json 
FROM (
    SELECT OBJECT_CONSTRUCT('conversation_id', CONVERSATION_ID, 'start_time', START_TIME, 'end_time', END_TIME, 'agent_name', AGENT_NAME, 'customer_name', CUSTOMER_NAME, 'transcript', TRANSCRIPT) 
    FROM CURSOR_DEMO.DATA_PREP.support_conv_initial) FILE_FORMAT = (TYPE = JSON) 
    OVERWRITE = TRUE
;
```
Exports the initial conversation data to a JSON file in the call_data_initial stage. Each row is converted to a JSON object with fields for conversation_id, timestamps, agent and customer names, and the transcript.

### 5. JSON File Format Definition
```sql
CREATE OR REPLACE FILE FORMAT Cursor_Demo.DATA_PREP.json_format
  TYPE = JSON;
```
Defines a file format specification for handling JSON files in the data pipeline.

### 6. Stage Creation for New Data
```sql
CREATE OR REPLACE STAGE Cursor_Demo.DATA_PREP.call_data_new;
```
Creates a stage for storing new JSON files generated by the ongoing data pipeline.

### 7. New Conversations Table Creation
```sql
CREATE OR REPLACE TABLE Cursor_Demo.DATA_PREP.SUPPORT_CONVERSATIONS_NEW (
    CONVERSATION_ID INT AUTOINCREMENT PRIMARY KEY,
    START_TIME TIMESTAMP_NTZ,
    END_TIME TIMESTAMP_NTZ,
    AGENT_ID INT,
    CUSTOMER_ID INT,
    SENTIMENT VARCHAR(20),
    ISSUE_RESOLVED BOOLEAN,
    DEVICE_NAME VARCHAR(100),
    COMMON_ISSUE VARCHAR(500),
    TRANSCRIPT VARCHAR(20000),
    FOREIGN KEY (AGENT_ID) REFERENCES Cursor_Demo.V1.SUPPORT_AGENTS(AGENT_ID),
    FOREIGN KEY (CUSTOMER_ID) REFERENCES Cursor_Demo.V1.CUSTOMERS(CUSTOMER_ID)
);
```
Creates a table for storing new conversation data with:
- Auto-incrementing conversation ID
- Timestamps for start and end times
- Foreign keys to agent and customer tables
- Sentiment and resolution status
- Device name and common issue
- Space for the full transcript

### 8. Transcript Generation Procedure
```sql
CREATE OR REPLACE PROCEDURE Cursor_Demo.DATA_PREP.GENERATE_TRANSCRIPTS_NEW_RECORDS()
```
Creates a stored procedure that:
- Identifies records without transcripts
- Builds detailed prompts for Claude AI based on conversation context
- Uses Snowflake Cortex to generate realistic support conversation transcripts
- Updates each record with the generated transcript
- Returns a success message with the count of transcripts generated

### 9. JSON Export Procedure
```sql
CREATE OR REPLACE PROCEDURE Cursor_Demo.DATA_PREP.EXPORT_CONVERSATIONS_TO_JSON()
```
Creates a stored procedure that:
- Generates a timestamp-based filename (format: YYYYMMDD_HHMMSS)
- Creates a temporary table with conversation data in JSON format
- Aggregates the JSON objects into an array
- Exports the data to a JSON file in the call_data_new stage
- Returns a success message with the filename

### 10. Batch Processing Procedure
```sql
CREATE OR REPLACE PROCEDURE Cursor_Demo.DATA_PREP.PROCESS_CONVERSATIONS_BATCH(NUM_EXECUTIONS INT DEFAULT 3)
```
Creates a comprehensive procedure that:
- Accepts a parameter for the number of executions (default: 3)
- Uses a REPEAT-UNTIL loop to process multiple conversations
- For each execution:
  - Generates a random 4+ digit conversation ID
  - Creates a new conversation record with random data
  - Calls the transcript generation procedure
  - Calls the JSON export procedure
  - Truncates the table to prepare for the next run
- Tracks results from all executions in an array
- Returns a consolidated summary of all processed conversations

### 11. Procedure Execution
```sql
CALL Cursor_Demo.DATA_PREP.PROCESS_CONVERSATIONS_BATCH();
```
Executes the batch processing procedure with the default of 3 iterations.

## Usage Examples

### Process a Single Conversation
```sql
CALL Cursor_Demo.DATA_PREP.PROCESS_CONVERSATIONS_BATCH(1);
```

### Process Multiple Conversations
```sql
CALL Cursor_Demo.DATA_PREP.PROCESS_CONVERSATIONS_BATCH(5);
```

### Generate Transcripts for Existing Records
```sql
CALL Cursor_Demo.DATA_PREP.GENERATE_TRANSCRIPTS_NEW_RECORDS();
```

### Export Conversations to JSON
```sql
CALL Cursor_Demo.DATA_PREP.EXPORT_CONVERSATIONS_TO_JSON();
```

## Data Flow
1. Initial data is extracted from SUPPORT_CONVERSATIONS and stored in support_conv_initial
2. Initial data is exported to a JSON file in the call_data_initial stage
3. New conversations are generated with random data in SUPPORT_CONVERSATIONS_NEW
4. Transcripts are generated for new conversations using Claude AI
5. New conversation data is exported to timestamped JSON files in the call_data_new stage
6. The process can be repeated to generate multiple conversations in a batch 